---
# title: "fbref Scraper"
# author: "saintsnumbers"
output:
  github_document:
    fig_height: 3
# date: 2019-10-09
editor_options:
  chunk_output_type: inline
---

```{r setup,include=F}
knitr::opts_chunk$set(echo=F,message=F,warning=F)

library(tidyverse)
library(rvest)
library(readr)
library(understatr)
library(ggsoccer)
library(ggrepel)
library(ggthemes)

set.seed(9999)
theme_set(theme_bw())

source("./R/fbref-functions.R")
source("./R/fbref-import.R")
source("./R/fbref-themes.R")
```

```{r plots}
EPLPlayerStats %>%
  filter(Squad=="Southampton") %>%
  arrange(desc(Minutes)) %>%
  ggplot(aes(x=reorder(Player,Minutes),y=Minutes)) +
  geom_bar(stat="identity",fill=sfc,width=0.8,alpha=0.6) +
  geom_label(aes(label=Minutes),colour=sfc_light,size=2) +
  themesfc() +
  theme(panel.grid.major.x=element_line(size=0.1,
                                        linetype="dashed"),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.y=element_blank(),
        panel.grid.minor.y=element_blank()) +
  labs(title="League minutes",
       x=element_blank(),
       y=element_blank()) +
  scale_y_continuous(breaks=seq(0,90*38,90)) +
  coord_flip()
ggsave("./plots/fbref/Minutes.jpg")

EPLPlayerStats %>%
  filter(Squad=="Southampton") %>%
  filter(xG+xA>0) %>%
  ggplot(aes(x=npxG,y=xA)) +
  geom_point(colour=sfc,size=1.5,alpha=0.8) +
  geom_text_repel(aes(label=Player),size=3) +
  themesfc() +
  labs(title="Southampton EPL xG/xA (non-penalty)",
       x="npxG",
       y="xA")
ggsave("./plots/fbref/npxGxA.jpg")

EPLTeamStats %>%
  ggplot(aes(x=reorder(Squad,npxG),y=npxG,fill=Squad)) +
  geom_bar(stat="identity",alpha=0.8) +
  themesfc() +
  labs(title="EPL xG (non-penalty)",
       x=element_blank(),
       y="npxG") +
  scale_fill_manual(values=col_epl()) +
  coord_flip()
ggsave("./plots/fbref/EPLnpxG.jpg")
```

```{r test,include=F}
EPLTeamStats %>%
  str()

EPLPlayerStats %>%
  filter(Squad %in% c("Southampton","Chelsea","Norwich City")) %>%
  filter(Minutes>400) %>%
  mutate(xA90=(90*xA/Minutes)) %>%
  arrange(desc(xA90)) %>%
  head(20) %>%
  ggplot() +
  geom_bar(aes(x=reorder(Player,xA90),y=xA90,fill=Squad),stat="identity",alpha=0.8) +
  themesfc() +
  scale_fill_manual(values=col_epl()) +
  coord_flip()
```