---
# title: "fbref Scraper"
# author: "saintsnumbers"
output:
  github_document:
    # fig_height: 3
# date: 2019-10-09
editor_options:
  chunk_output_type: inline
---

```{r setup,include=F}
knitr::opts_chunk$set(echo=F,message=F,warning=F)

library(tidyverse)
library(rvest)
library(readr)
library(understatr)
library(ggsoccer)
library(ggrepel)
library(ggthemes)
library(glue)

set.seed(9999)
theme_set(theme_bw())

source("./R/fbref-functions.R")
source("./R/fbref-import.R")
source("./R/fbref-tidy-player.R")
source("./R/fbref-tidy-team.R")
source("./R/fbref-themes.R")
```

### Southampton plots

```{r plots-sfc}
Players %>%
  filter(Squad=="Southampton") %>%
  ggplot(aes(x=reorder(Player,Min),y=Min)) +
  geom_bar(stat="identity",fill=sfc,width=0.8,alpha=0.6) +
  geom_label(aes(label=Min),colour=sfc_light,size=2) +
  theme_sfc() +
  theme(panel.grid.major.x=element_line(size=0.1,
                                        linetype="dashed"),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.y=element_blank(),
        panel.grid.minor.y=element_blank()) +
  labs(title="League minutes",
       x=element_blank(),
       y=element_blank(),
       caption="statsbomb/fbref") +
  scale_y_continuous(breaks=seq(0,90*38,90)) +
  coord_flip()
ggsave("./plots/fbref/SFCMinutes.jpg")

Players %>%
  filter(Squad=="Southampton") %>%
  filter(xG+xA>0) %>%
  ggplot(aes(x=npxG,y=xA)) +
  geom_point(colour=sfc,size=1.5,alpha=0.8) +
  geom_text_repel(aes(label=ifelse(npxG+xA>0.6,Player,element_blank())),size=3) +
  theme_sfc() +
  labs(title="Southampton EPL xG/xA (non-penalty)",
       x="xG",
       y="xA",
       caption="statsbomb/fbref")
ggsave("./plots/fbref/SFCnpxGxA.jpg")

Players %>%
  filter(Squad=="Southampton") %>%
  filter(xG90+xA90>0) %>%
  ggplot(aes(x=npxG90,y=xA90)) +
  geom_point(colour=sfc,size=1.5,alpha=0.8) +
  geom_text_repel(aes(label=ifelse(npxG90+xA90>0.1,Player,element_blank())),size=3) +
  theme_sfc() +
  labs(title="Southampton EPL xG/xA per 90 minutes (non-penalty)",
       x="xG per 90",
       y="xA per 90",
       caption="statsbomb/fbref")
ggsave("./plots/fbref/SFCnpxGxA90.jpg")

Players %>%
  filter(Squad=="Southampton") %>%
  filter(`1/3`+PenArea>0) %>%
  ggplot(aes(x=`1/3`,y=PenArea)) +
  geom_point(colour=sfc,size=1.5,alpha=0.8) +
  geom_text_repel(aes(label=ifelse(`1/3`+PenArea>8,Player,element_blank())),size=3) +
  theme_sfc() +
  labs(title=element_blank(),
       x="Passes into final third",
       y="Passes into penalty area",
       caption="statsbomb/fbref")
ggsave("./plots/fbref/SFCAttackingPasses.jpg")

Players %>%
  filter(Squad=="Southampton") %>%
  # filter(!is.na(`+/-`)) %>%
  mutate(PlusMinusPos=ifelse(`+/-`>=0,TRUE,FALSE)) %>%
  ggplot(aes(x=reorder(Player,`+/-`),y=`+/-`)) +
  geom_bar(aes(fill=PlusMinusPos),stat="identity",width=0.8,alpha=0.6) +
  theme_sfc() +
  theme(panel.grid.minor.x=element_blank()) +
  labs(title="On-pitch goal difference",
       x=element_blank(),
       y="goals scored - goals conceded\nwhile on the pitch",
       caption="statsbomb/fbref") +
  scale_fill_manual(values=c(col_gdocs[[2]],col_gdocs[[4]])) +
  scale_y_reverse() +
  coord_flip()
ggsave("./plots/fbref/SFCGoalDifference.jpg")

Players %>%
  filter(Squad=="Southampton") %>%
  filter(!is.na(`xG+/-90`)) %>%
  mutate(PlusMinusPos=ifelse(`xG+/-90`>=0,TRUE,FALSE)) %>%
  ggplot(aes(x=reorder(Player,`xG+/-90`),y=`xG+/-90`)) +
  geom_bar(aes(fill=PlusMinusPos),stat="identity",width=0.8,alpha=0.6) +
  theme_sfc() +
  labs(title="On-pitch expected goals difference (per 90 minutes)",
       x=element_blank(),
       y="expected goals scored - expected goals conceded\nper 90 minutes while on the pitch",
       caption="statsbomb/fbref") +
  scale_fill_manual(values=c(col_gdocs[[2]],col_gdocs[[4]])) +
  scale_y_reverse() +
  coord_flip()
ggsave("./plots/fbref/SFCxG90Difference.jpg")
```

### Premier League plots

```{r plots-epl}
Teams %>%
  ggplot(aes(x=reorder(Squad,npxG),y=npxG,fill=Squad)) +
  geom_bar(stat="identity",alpha=0.8) +
  theme_sfc() +
  labs(title="EPL xG (non-penalty)",
       x=element_blank(),
       y="npxG",
       caption="statsbomb/fbref") +
  scale_fill_manual(values=palette_epl()) +
  coord_flip()
ggsave("./plots/fbref/EPLnpxG.jpg")

Table_raw %>%
  ggplot(aes(x=reorder(Squad,desc(xGA)),y=xGA,fill=Squad)) +
  geom_bar(stat="identity",alpha=0.8) +
  theme_sfc() +
  labs(title="EPL expected goals allowed (non-penalty)",
       x=element_blank(),
       y="xGA",
       caption="statsbomb/fbref") +
  scale_fill_manual(values=palette_epl()) +
  coord_flip()
ggsave("./plots/fbref/EPLnpxGA.jpg")

Table_raw %>%
  mutate(`xGA-GA`=xGA-GA) %>%
  ggplot(aes(x=reorder(Squad,`xGA-GA`),y=`xGA-GA`,fill=Squad)) +
  geom_bar(stat="identity",alpha=0.8) +
  theme_sfc() +
  labs(title="EPL expected goals allowed - goals allowed",
       x=element_blank(),
       y="xGA-GA",
       caption="statsbomb/fbref") +
  scale_fill_manual(values=palette_epl()) +
  coord_flip()
ggsave("./plots/fbref/EPLnpxGA-GA.jpg")
```

```{r data-frames}
# Players %>%
#   filter(Squad=="Southampton") %>%
#   glimpse()
# 
# Teams %>%
#   glimpse()
```



```{r test,include=F}
Players %>%
  filter(Squad=="Southampton") %>%
  # mutate(PassRatio=(max(Left,Right)/(Left+Right)) %>% abs %>% round(digits=2)) %>%
  gather("Left","Right",key="PassFoot",value="Passes") %>%
  ggplot(aes(x=reorder(Player,Passes),y=Passes)) +
  geom_bar(aes(fill=PassFoot),stat="identity") +
  # geom_label(aes(label=PassRatio),colour=sfc_light,size=2) +
  # theme_sfc() +
  labs(title=element_blank(),
       x=element_blank(),
       y="Total passes",
       caption="statsbomb/fbref",
       legend.position="right") +
  scale_fill_manual(values=c(col_medium[[1]],col_medium[[8]])) +
  coord_flip()
# ggsave("./plots/fbref/SFCPassFootedness.jpg",height=4)

Players %>%
  filter(Squad=="Southampton") %>%
  mutate(Passes=Left+Right) %>%
  ggplot(aes(x=reorder(Player,Passes))) +
  geom_bar(aes(y=Right),stat="identity",fill=col_light[[1]]) +
  geom_bar(aes(y=-Left),stat="identity",fill=col_medium[[8]]) +
  coord_flip()

# Players %>%
#   filter(Squad=="Southampton") %>%
#   max(Left,Right)
```