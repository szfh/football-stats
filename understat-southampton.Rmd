---
title: "Southampton FC Understat Scraper"
author: "saintsnumbers"
output: github_document
date: 2019-08-14
editor_options: 
  chunk_output_type: inline
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)

#libraries
library(tidyverse)
library(rvest)
library(magrittr)
library(understatr)
library(ggtext)
library(ggrepel)
set.seed(9999)
theme_set(theme_bw())

#delete environment variables
rm(list=ls())
```

## Scraping Southampton FC Understat data

### Plots from 2018

```{r plots}
team <- "Southampton"
year <- 2018
source <- c(team,year)

get_team_players_stats(source[[1]],source[[2]]) %>%
  filter(time>0) %>%
  mutate(player_name=factor(player_name,levels=player_name[order(time)])) %>%
  ggplot(aes(x=player_name,y=time)) +
  geom_bar(stat="identity",fill="#e61919",width=0.8,alpha=0.6) +
  labs(title=paste0("League minutes ",as.integer(source[[2]]),"-",as.integer(source[[2]])+1)) +
  theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +
  coord_flip()
ggsave(paste0("./plots/","TeamStats_",source[[1]],"_",source[[2]],".jpg"))

get_team_players_stats(source[[1]],source[[2]]) %>%
  filter(xG > 0) %>%
  mutate(player_name=factor(player_name,levels=player_name[order(xG)])) %>%
  ggplot(aes(x=player_name,y=xG)) +
  geom_bar(stat="identity",fill="#e61919",width=0.8,alpha=0.6) +
  labs(title=paste0("League xG ",as.integer(source[[2]]),"-",as.integer(source[[2]])+1)) +
  theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +
  coord_flip()
ggsave(paste0("./plots/","PlayerStats_",source[[1]],"_",source[[2]],".jpg"))

get_team_players_stats(source[[1]],source[[2]]) %>%
  filter((xG > 0)|(xA > 0)) %>%
  ggplot(aes(x=xG,y=xA)) +
  geom_point(colour="#e61919",alpha=0.6) +
  # geom_text(aes(label=ifelse(xG+xA>=1,player_name,""),hjust="inward",vjust="outward"),size=1.5) +
  geom_label_repel(aes(label=ifelse(xG+xA>=1,player_name,""))) +
  labs(title=paste0("League xG/xA ",as.integer(source[[2]]),"-",as.integer(source[[2]])+1),x="xG",y="xA") +
  coord_fixed()
ggsave(paste0("./plots/","xGxA_",source[[1]],"_",source[[2]],"_Point.jpg"))

get_team_players_stats(source[[1]],source[[2]]) %>%
  filter((xG > 0)|(xA > 0)) %>%
  mutate(player_name=factor(player_name,levels=player_name[order(xG)])) %>%
  gather("xG","xA",key="x",value="xN") %>%
  select("player_name","x","xN") %>%
  mutate(x=factor(x,levels=c("xG","xA"))) %>%
  ggplot(aes(x=player_name,y=xN,fill=x)) +
  geom_bar(stat="identity",position="dodge") +
  labs(title=paste0("League xG/xA ",as.integer(source[[2]]),"-",as.integer(source[[2]])+1)) +
  theme(axis.title.x=element_blank(),axis.title.y=element_blank(),legend.title=element_blank()) +
  coord_flip()
ggsave(paste0("./plots/","xGxA_",source[[1]],"_",source[[2]],"_Bar.jpg"))

get_team_players_stats(source[[1]],source[[2]]) %>%
  filter(key_passes > 0) %>%
  mutate(player_name=factor(player_name,levels=player_name[order(key_passes)])) %>%
  ggplot(aes(x=player_name,y=key_passes)) +
  geom_bar(stat="identity",fill="#e61919",width=0.8,alpha=0.6) +
  labs(title=paste0("Key passes ",as.integer(source[[2]]),"-",as.integer(source[[2]])+1)) +
  theme(axis.title.x=element_blank(),axis.title.y=element_blank()) +
  coord_flip()
ggsave(paste0("./plots/","KeyPasses_",source[[1]],"_",source[[2]],".jpg"))

get_match_shots(11666) %>%
  mutate(team = ifelse(h_a == "h", h_team, a_team)) %>%
  # filter(team == "Southampton") %>%
  ggplot(aes(x=X,y=Y,size=xG,colour=team)) +
  geom_point()
```

### Data

```{r data, echo=T}
get_match_shots(11666) %>%
  mutate(team = ifelse(h_a == "h", h_team, a_team)) %>%
  group_by(team,situation,result) %>%
  summarise(n = n())
```